@model ListingViewModel
@using Microsoft.AspNetCore.Identity
@inject UserManager<ApplicationUser> UserManager

@section Styles {
    <link rel="stylesheet" href="~/css/viewlisting.css" />
}
@{
    var loggedInUser = await UserManager.GetUserAsync(User);
}
<div class="hero">
    <div class="rental-wrapper">
        @if (loggedInUser != null && Model.User.Id == loggedInUser.Id)
        {
            <img class="rental-banner" src="@Model.Listing.ListningImageURL" alt="Forside bilde." />
            <div class="rental-content">
                <div class="rental-about">
                    <h1 class="rental-title">@Model.Listing.ListningName</h1>
                    <p class="rental-info">Antall senger @Model.Listing.NoOfBeds - Størrelse @Model.Listing.SquareMeter</p>
                    <hr>
                    <div class="rental-host">
                        <p>About the host</p>
                        <h3>@Model.User.UserName</h3>
                        <div class="rental-host-contact">
                            <p>@Model.User.Email</p>
                            <p>@Model.User.PhoneNumber</p>
                            <p>@Model.User.FirstName</p>
                        </div>
                    </div>
                    <hr>
                    <p class="rental-desc">@Model.Listing.ListningDescription</p>

                </div>
                <div class="rental-booking">
                </div>

            </div>
        }
        else
        {
            <img class="rental-banner" src="@Model.Listing.ListningImageURL" alt="Forside bilde." />
            <div class="rental-content">
                <div class="rental-about">
                    <h1 class="rental-title">@Model.Listing.ListningName</h1>
                    <p class="rental-info">Antall senger @Model.Listing.NoOfBeds - Størrelse @Model.Listing.SquareMeter</p>
                    <hr>
                    <div class="rental-host">
                        <p>About the host</p>
                        <h3>@Model.User.UserName</h3>
                        <div class="rental-host-contact">
                            <p>@Model.User.Email</p>
                            <p>@Model.User.PhoneNumber</p>
                            <p>@Model.User.FirstName</p>
                        </div>
                    </div>
                    <hr>
                    <p class="rental-desc">@Model.Listing.ListningDescription</p>


                    <form asp-action="ViewListing" method="post" enctype="form-data">
                        <input type="hidden" asp-for="@Model.Listing.ListningId" />

                        <div class="form-group">
                            <label asp-for="@Model.Booking.FromDate">Available From</label><span class="text-danger">*</span>
                            <input asp-for="@Model.Booking.FromDate" id="fromDateInput" type="text" class="form-control"  />
                            <span asp-validation-for="@Model.Booking.FromDate" class="text-danger"></span>
                        </div>

                        <div class="form-group">
                            <label asp-for="@Model.Booking.ToDate">Available To</label><span class="text-danger">*</span>
                            <input asp-for="@Model.Booking.ToDate" id="toDateInput" type="text" class="form-control" />
                            <span asp-validation-for="@Model.Booking.ToDate" class="text-danger"></span>
                        </div>
                        <button type="submit" class="btn btn-primary">Book</button>

                    </form>

                </div>
                <div class="rental-booking">
                </div>

            </div>
        }
    </div>
</div>

<script>



    $(document).ready(function () {
        var listningId = $('#Listing_ListningId').val(); // henter verdien fra form

        // Forespørsel for å hente tilgjengelige datoer for listningen
        $.ajax({
            url: '/Explorer/GetAvailableDatesForListning?listningId=' + listningId,
            method: 'GET',
            dataType: 'json',
            success: function (availabilityData) {
                // Forespørsel for å hente bookede datoer
                $.ajax({
                    url: '/Explorer/GetBookedDates?listningId=' + listningId,
                    method: 'GET',
                    dataType: 'json',
                    success: function (bookedDates) {
                        // Konverterer datoene til 'yy-mm-dd' format
                        var convertedBookedDates = bookedDates.map(date => date.split('T')[0]);

                        // Finn den første bookede datoen
                        var firstBookedDate = new Date(convertedBookedDates.sort()[0]);

                        // Få dagen før første booking
                        firstBookedDate.setDate(firstBookedDate.getDate() - 1);

                        // Setter initialverdier for dato-inputfeltene
                        $("#fromDateInput").val(jQuery.datepicker.formatDate('yy-mm-dd', new Date(availabilityData.fromDate)));
                        $("#toDateInput").val(jQuery.datepicker.formatDate('yy-mm-dd', firstBookedDate));

                        $("#fromDateInput").datepicker({
                            dateFormat: "yy-mm-dd",
                            minDate: new Date(availabilityData.fromDate),
                            maxDate: new Date(availabilityData.toDate),
                            beforeShowDay: function (date) {
                                var string = jQuery.datepicker.formatDate('yy-mm-dd', date);
                                return [convertedBookedDates.indexOf(string) === -1];
                            },
                            onSelect: function (selectedDate) {
                                $("#toDateInput").datepicker("option", "minDate", selectedDate);
                            }
                        });

                        $("#toDateInput").datepicker({
                            dateFormat: "yy-mm-dd",
                            minDate: new Date(availabilityData.fromDate),
                            maxDate: new Date(availabilityData.toDate),
                            beforeShowDay: function (date) {
                                var string = jQuery.datepicker.formatDate('yy-mm-dd', date);
                                return [convertedBookedDates.indexOf(string) === -1];
                            },
                            onSelect: function (selectedDate) {
                                $("#fromDateInput").datepicker("option", "maxDate", selectedDate);
                            }
                        });

                    },
                    error: function (error) {
                        console.error("Error fetching booked dates:", error);
                    }
                });
            },
            error: function (error) {
                console.error("Error fetching available dates:", error);
            }
        });
    });




</script>
