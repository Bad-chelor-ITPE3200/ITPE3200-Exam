@model ListingViewModel
@using Microsoft.AspNetCore.Identity
@inject UserManager<ApplicationUser> UserManager

@section Styles {
    <link rel="stylesheet" href="~/css/viewlisting.css" />
}
@{
    var loggedInUser = await UserManager.GetUserAsync(User);
}
<div class="hero">
    <div class="rental-wrapper">
        @if (loggedInUser != null && Model.User.Id == loggedInUser.Id)
        {
            <img class="rental-banner" src="@Model.Listing.ListningImageURL" alt="Forside bilde."/>
            <div class="rental-content">
                <div class="rental-about">
                    <h1 class="rental-title">@Model.Listing.ListningName</h1>
                    <p class="rental-info">Antall senger @Model.Listing.NoOfBeds - Størrelse @Model.Listing.SquareMeter</p>
                    <hr>
                    <div class="rental-host">
                        <p>About the host</p>
                        <h3>@Model.User.UserName</h3>
                        <div class="rental-host-contact">
                            <p>@Model.User.Email</p>
                            <p>@Model.User.PhoneNumber</p>
                            <p>@Model.User.FirstName</p>
                        </div>
                    </div>
                    <hr>
                    <p class="rental-desc">@Model.Listing.ListningDescription</p>
                    
                </div>
                <div class="rental-booking">

                </div>
                
            </div>
        }
        else
        {
            <img class="rental-banner" src="@Model.Listing.ListningImageURL" alt="Forside bilde." />
            <div class="rental-content">
                <div class="rental-about">
                    <h1 class="rental-title">@Model.Listing.ListningName</h1>
                    <p class="rental-info">Antall senger @Model.Listing.NoOfBeds - Størrelse @Model.Listing.SquareMeter</p>
                    <hr>
                    <div class="rental-host">
                        <p>About the host</p>
                        <h3>@Model.User.UserName</h3>
                        <div class="rental-host-contact">
                            <p>@Model.User.Email</p>
                            <p>@Model.User.PhoneNumber</p>
                            <p>@Model.User.FirstName</p>
                        </div>
                    </div>
                    <hr>
                    <p class="rental-desc">@Model.Listing.ListningDescription</p>
             
                    
                    
                    <form asp-action="ViewListing" method="post" enctype="form-data">
                        <input type="hidden" asp-for="@Model.Listing.ListningId" />
                        <input type="hidden" asp-for="@Model.Listing.ListningPrice" />

                        <div class="form-group">
                            <label asp-for="@Model.Booking.FromDate">Available From</label><span class="text-danger">*</span>
                            <input asp-for="@Model.Booking.FromDate" id="fromDateInput" type="date" class="form-control"  />
                            <span asp-validation-for="@Model.Booking.FromDate" class="text-danger"></span>
                        </div>

                        <div class="form-group">
                            <label asp-for="@Model.Booking.ToDate">Available To</label><span class="text-danger">*</span>
                            <input asp-for="@Model.Booking.ToDate" id="toDateInput" type="date" class="form-control" />
                            <span asp-validation-for="@Model.Booking.ToDate" class="text-danger"></span>
                        </div>
                        <button type="submit" class="btn btn-primary">Book</button>

                    </form>
        @**<div class="form-group">
            <label asp-for="Listning.NoOfBeds"></label>
            <input asp-for="Listning.NoOfBeds" class="form-control" />
            <span asp-validation-for="Listning.NoOfBeds" class="text-danger"></span>
        </div>
           **@         

                </div>
                <div class="rental-booking">
                </div>

            </div>
        }
    </div>
</div>

<script>
    $(document).ready(function () {
        // Retrieve the value from the form
        var listingId = @Model.Listing.ListningId

        // AJAX request to fetch available dates for the listing
        $.ajax({
                url: '/Explorer/GetAvailableDates?listingId=' + listingId,
            method: 'GET',
            dataType: 'json',
            success: function (availabilityData) {
                // AJAX request to fetch booked dates
                $.ajax({
                    url: '/Explorer/GetBookedDates?listingId=' + listingId,
                    method: 'GET',
                    dataType: 'json',
                    success: function (bookedDates) {
                        // Convert dates to 'yy-mm-dd' format
                        var convertedBookedDates = bookedDates.map(date => date.split('T')[0]);

                        // Find the first booked date
                        var firstBookedDate = new Date(convertedBookedDates.sort()[0]);

                        // Get the day before the first booking
                        firstBookedDate.setDate(firstBookedDate.getDate() - 1);

                        // Set initial values for date input fields based on availability data
                        $("#fromDateInput").val(jQuery.datepicker.formatDate('yy-mm-dd', new Date(availabilityData.fromDate)));
                        $("#toDateInput").val(jQuery.datepicker.formatDate('yy-mm-dd', firstBookedDate));

                        // Configure the "From Date" picker
                        $("#fromDateInput").datepicker({
                            dateFormat: "yy-mm-dd",
                            minDate: new Date(availabilityData.fromDate),
                            maxDate: new Date(availabilityData.toDate),
                            beforeShowDay: function (date) {
                                // Check if the date is already booked
                                var string = jQuery.datepicker.formatDate('yy-mm-dd', date);
                                return [convertedBookedDates.indexOf(string) === -1];
                            },
                            onSelect: function (selectedDate) {
                                // Set the minimum date for the "To Date" picker based on the selected date in the "From Date" picker
                                $("#toDateInput").datepicker("option", "minDate", selectedDate);
                            }
                        });

                        // Configure the "To Date" picker
                        $("#toDateInput").datepicker({
                            dateFormat: "yy-mm-dd",
                            minDate: new Date(availabilityData.fromDate),
                            maxDate: new Date(availabilityData.toDate),
                            beforeShowDay: function (date) {
                                // Check if the date is already booked
                                var string = jQuery.datepicker.formatDate('yy-mm-dd', date);
                                return [convertedBookedDates.indexOf(string) === -1];
                            },
                            onSelect: function (selectedDate) {
                                // Set the maximum date for the "From Date" picker based on the selected date in the "To Date" picker
                                $("#fromDateInput").datepicker("option", "maxDate", selectedDate);
                            }
                        });

                    },
                    error: function (error) {
                        // Log an error if there's a problem fetching booked dates
                        console.error("Error fetching booked dates:", error);
                    }
                });
            },
            error: function (error) {
                // Log an error if there's a problem fetching available dates
                console.error("Error fetching available dates:", error);
            }
        });
    });
</script>
